<!DOCTYPE html>
{% load static %}
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
    <style>
        body {margin:0}
    </style>
  </head>
  <body>
    <div>
    <script src="{% static 'js/three.js' %}"></script>
    <script type="module">
      import {NURBSCurve} from "{% static 'js/NURBSCurve.js' %}";
      import { TrackballControls } from "{% static 'js/TrackballControls.js' %}";

      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0xf0f0f0);
      // Camera
      var viewsize = window.innerHeight;
      var ratio = window.innerWidth/window.innerHeight;
      var left = -viewsize*ratio/2;
      var right = viewsize*ratio/2;
      var top = viewsize/2;
      var bottom = -viewsize/2;
      const camera = new THREE.OrthographicCamera(left,right,top,bottom,-1000,1000);
      camera.position.set( 50, 50, 50 );
      camera.lookAt( 0, 0, 0 );
      camera.up.set(0,0,1);
      //const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 1000 );


      //helper
      var CameraHelper = new THREE.CameraHelper(camera);
      scene.add(CameraHelper);
      const axesHelper = new THREE.AxesHelper( 10 );
      const plane = new THREE.Plane( new THREE.Vector3( 0,0,0 ), 0 );
      const helper = new THREE.PlaneHelper( plane, 1, 0xffff00 );
      scene.add( helper );
      scene.add( axesHelper );

      const renderer = new THREE.WebGLRenderer();
      renderer.setSize( window.innerWidth, window.innerHeight );
      document.body.appendChild( renderer.domElement );

      //controler
      const controls = new TrackballControls( camera, renderer.domElement );
      controls.rotateSpeed = 1.2;
      controls.zoomSpeed = 1.2;
      controls.panSpeed = 1.2;
      controls.keys = [ 65, 83, 68 ];

      const material = new THREE.LineBasicMaterial( { color: 0x0000ff } );



      var importHull = function(){
        //TEST!!
        {% autoescape off %}
        var hull = JSON.parse('{{testjson}}')
        {% endautoescape %}
        var wlkey = Object.keys(hull.Waterline.Fore)
        wlkey.forEach(function(element){
            let controlPoints  =  [];
            hull.Waterline.Fore[element].control.forEach(function(line){
            controlPoints.push(new THREE.Vector3(line[0],line[1],line[2]))
            })
            let knots =hull.Waterline.Fore[element].U;
            let curve = new NURBSCurve( 3, knots, controlPoints, 0, 0 );
      			let vertices = curve.getPoints( controlPoints.length * 7 );
      			let positions = new Float32Array( vertices.length * 3 );
      			vertices.forEach( function ( vertex, i ) {
      				vertex.toArray( positions, i * 3 );
      			});

      			let geometry = new THREE.BufferGeometry();
      			geometry.setAttribute( 'position', new THREE.BufferAttribute( positions, 3 ) );
            let line_gl = new THREE.Line(geometry,material);
            scene.add(line_gl);
        })
        var wlakey = Object.keys(hull.Waterline.After)
        wlakey.forEach(function(element){
            let controlPoints  =  [];
            hull.Waterline.After[element].control.forEach(function(line){
            controlPoints.push(new THREE.Vector3(line[0],line[1],line[2]))
            })
            let knots =hull.Waterline.After[element].U;
            let curve = new NURBSCurve( 3, knots, controlPoints, 0, 0 );
      			let vertices = curve.getPoints( controlPoints.length * 7 );
      			let positions = new Float32Array( vertices.length * 3 );
      			vertices.forEach( function ( vertex, i ) {
      				vertex.toArray( positions, i * 3 );
      			});

      			let geometry = new THREE.BufferGeometry();
      			geometry.setAttribute( 'position', new THREE.BufferAttribute( positions, 3 ) );
            let line_gl = new THREE.Line(geometry,material);
            scene.add(line_gl);
        })
        var stfkey = Object.keys(hull.Station.Fore)
        stfkey.forEach(function(element){
            let controlPoints  =  [];
            hull.Station.Fore[element].control.forEach(function(line){
            controlPoints.push(new THREE.Vector3(line[0],line[1],line[2]))
            })
            let knots =hull.Station.Fore[element].U;
            let curve = new NURBSCurve( 3, knots, controlPoints, 0, 0 );
      			let vertices = curve.getPoints( controlPoints.length * 7 );
      			let positions = new Float32Array( vertices.length * 3 );
      			vertices.forEach( function ( vertex, i ) {
      				vertex.toArray( positions, i * 3 );
      			});

      			let geometry = new THREE.BufferGeometry();
      			geometry.setAttribute( 'position', new THREE.BufferAttribute( positions, 3 ) );
            let line_gl = new THREE.Line(geometry,material);
            scene.add(line_gl);
        })
        /*
        var special = [hull.STEM,hull.STERN,hull.FOBA,hull.FOBF,hull.FOSA,hull.FOSF]

        special.forEach(function(line_ele){
            let controlPoints  =  [];
            line_ele.control.forEach(function(line){
            controlPoints.push(new THREE.Vector3(line[0],line[1],line[2]))
            })

            let knots =line_ele.U;
            let curve = new NURBSCurve( 3, knots, controlPoints, 0, 0 );
      			let vertices = curve.getPoints( controlPoints.length * 7 );
      			let positions = new Float32Array( vertices.length * 3 );
      			vertices.forEach( function ( vertex, i ) {
      				vertex.toArray( positions, i * 3 );
      			});

      			let geometry = new THREE.BufferGeometry();
      			geometry.setAttribute( 'position', new THREE.BufferAttribute( positions, 3 ) );
            let line_gl = new THREE.Line(geometry,material);
            scene.add(line_gl);
        })
        */



      //import Hull end
      }

      var render = function(){
        renderer.render( scene, camera );
    }
      var animation = function(){
        requestAnimationFrame(animation);
        controls.update();
        render();

      }
      importHull();
      animation();
    </script>

    </div>

  </body>
</html>
